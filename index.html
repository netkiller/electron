<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'" /> -->
  <!-- <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'" /> -->
  <title>Hello from Electron renderer!</title>
  <!-- <script type="text/javascript" xlink:href="svg/svg.min.js"></script> -->
  <script src="svg/svg.min.js"></script>
  <script src="js/jquery-3.6.4.min.js"></script>

  <script>
    // run this function when the document is loaded
    window.onload = function () {
      // create a couple of elements
      // in an otherwise empty HTML page
      heading = document.createElement("h1");
      heading_text = document.createTextNode("Big Head!");
      heading.appendChild(heading_text);
      // document.body.appendChild(heading);
      document.getElementById("title").appendChild(heading);
    }
  </script>
  <style>
    #gantt {
      width: 100%;
      height: 100%;

      display: block;
    }

    #title {
      color: #f06;
    }

    #gantt #table {
      float: left;
      /* width: 450px; */
      /* width: 100%; */
    }

    #gantt #chart {
      /* width: 100%; */
      /* float: right; */
      float: left;
      overflow-x: auto;
      /* margin-left: 400px; */
      /* margin-left: 410px; */
    }

    table {
      border-collapse: collapse;
    }

    table,
    th,
    td {
      border: 1px solid grey;
    }

    table caption {
      height: 60px;
    }

    table thead th {
      height: 28px;
    }

    table tbody td {
      height: 27px;
    }

    .taskbar {
      cursor: e-resize;
    }

    .process {
      cursor: e-resize;
    }

    #main {
      float: :left;
    }

    #menu {
      float: unset;
      display: block;
    }

    /* form */
    #number {
      width: 3em;
    }
  </style>
</head>

<body>


  <div id="main">
    <div id="title"></div>
    <div id="gantt">
      <div id="table"></div>
      <div id="chart"></div>
    </div>
  </div>


  <div id="menu">

    <fieldset>
      <legend>Choose your favorite monster</legend>
      <!-- <form action="http://localhost:8080/project/save" method="POST" target="_blank" accept-charset="UTF-8" enctype="application/json" autocomplete="on" novalidate> -->
      <label for="name">任务</label>
      <input type="text" id="name" name="name" />
      <label for="start">开始日期：</label>
      <input type="date" id="start" name="start" min="2022-01-01" max="2025-12-31" required />
      <label for="finish">开始日期：</label>
      <input type="date" id="finish" name="finish" min="2022-01-01" max="2025-12-31" required />
      <label for="duration">预计工时：</label>
      <input type="number" name="duration" id="duration" min="1" max="31" step="1" />
      <input type="range" name="duration1" id="duration1" min="1" max="31" step="1"
        onchange="duration.value = this.value" />

      <label for="resource">资源</label>
      <input type="text" name="resource" id="resource" list="resourceSuggestion" value="Neo" />
      <datalist id="resourceSuggestion">
        <option></option>
      </datalist>

      <label for="milestone">里程碑：</label>
      <input type="checkbox" id="milestone" name="milestone" value="false" />
      <label for="predecessor">前置任务：</label>
      <select name="predecessor" id="predecessor">
        <option value="0">-- 无 --</option>
      </select>
      <label for="parent">父任务：</label>
      <select name="parent" id="parent">
        <option value="0">-- 无 --</option>
      </select>
      <!-- <input type="submit" value="提交"> -->
      <button onclick="addRow()">添加</button>
      <button onclick="save()">提交</button>
      <!-- </form> -->
    </fieldset>
  </div>
</body>


<script src="js/table.js"></script>
<script src="js/gantt.js"></script>
<script type="text/javascript">
  // <![CDATA[

  mouseStatus = true;

  function GanttInit() {
    var url = 'http://localhost:8080/project/init';
    var gantt = null;
    $.ajaxSettings.async = false;
    $.getJSON(url, function (data) {

      gantt = new Gantt(data.from, data.to)
      gantt.calendar();
      gantt.table();

    });
    return gantt;
  }

  const gantt = GanttInit()

  // gantt = new Gantt('2022-12-26','2023-04-05')

  $.ajaxSettings.async = false;
  $.getJSON('http://localhost:8080/project/resource/lists', function (data) {
    gantt.initResource(data);
    // $.each(data, function (id, resource) {
    // gantt.initResource(resource, resource);

    // });
  });



  function addRow() {
    gantt.addTask();
    gantt.addBar()
  }


  $.ajax({
    url: 'http://localhost:8080/project/lists',
    method: 'GET',
    dataType: 'json',
    success: function (data) {

      gantt.initTasks(data);
      $.each(data, function (index, item) {
        gantt.addTask(item);
        gantt.addBar(item);
      });
      gantt.done();
      $.each(data, function (index, item) {
        if (item.predecessor != null) {
          gantt.linkPredecessor(item.id, item.predecessor);
        }
      });
      gantt.addTaskList(data);

    },
    error: function (xhr, status, error) {
      console.log(error);
    }
  });

  var date = new Date();

  /* 从日期中获取年月日部分 */
  // var year = date.toLocaleString("default", { year: "numeric" });
  // var month = date.toLocaleString("default", { month: "2-digit" });
  // var day = date.toLocaleString("default", { day: "2-digit" });
  var day = ("0" + date.getDate()).slice(-2);
  /*格式化月，如果小于9，则补0*/
  var month = ("0" + (date.getMonth() + 1)).slice(-2);

  /* 生成 yyyy-mm-dd 日期字符串 */
  var today = date.getFullYear() + "-" + month + "-" + day;
  var day = ("0" + (date.getDate() + 1)).slice(-2);
  var tomorrow = date.getFullYear() + "-" + month + "-" + day;
  console.log(tomorrow);

  const start = document.getElementById("start");
  start.value = today;
  const finish = document.getElementById("finish");
  finish.value = tomorrow;

  // ]]>
</script>

</html>